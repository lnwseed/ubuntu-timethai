#!/bin/bash

# ============================================
# р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕зр╕ер╕▓р╣Др╕Чр╕вр╣Гр╕Щ Ubuntu
# ============================================

echo "ЁЯЗ╣ЁЯЗн р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕зр╕ер╕▓р╣Др╕Чр╕вр╣Гр╕Щ Ubuntu"
echo "=========================================="

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М sudo
if [[ $EUID -ne 0 ]]; then
   echo "тЭМ р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╕кр╕┤р╕Чр╕Шр╕┤р╣М root р╕лр╕гр╕╖р╕н sudo"
   echo "р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕▒р╕Щр╕Фр╣Йр╕зр╕вр╕Др╕│р╕кр╕▒р╣Ир╕З: sudo bash $0"
   exit 1
fi

# р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕зр╕ер╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ
show_current_time() {
    echo "ЁЯУЕ р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕зр╕ер╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ:"
    echo "------------------------"
    timedatectl status
    echo ""
}

# р╣Бр╕кр╕Фр╕Зр╣Ар╕зр╕ер╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Бр╣Ир╕нр╕Щр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ
echo "тП░ р╣Ар╕зр╕ер╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Бр╣Ир╕нр╕Щр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ:"
show_current_time

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone р╣Ар╕Ыр╣Зр╕Щр╣Ар╕зр╕ер╕▓р╣Др╕Чр╕в
echo "ЁЯФз р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone р╣Ар╕Ыр╣Зр╕Щ Asia/Bangkok..."
timedatectl set-timezone Asia/Bangkok

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕кр╕│р╣Ар╕гр╣Зр╕Ир╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if [ $? -eq 0 ]; then
    echo "тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone р╕кр╕│р╣Ар╕гр╣Зр╕И"
else
    echo "тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone"
    exit 1
fi

# р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ NTP (Network Time Protocol)
echo "ЁЯМР р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ NTP..."
timedatectl set-ntp true

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░ NTP
if [ $? -eq 0 ]; then
    echo "тЬЕ р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ NTP р╕кр╕│р╣Ар╕гр╣Зр╕И"
else
    echo "тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ NTP"
fi

# р╕нр╕▒р╕Юр╣Ар╕Фр╕Хр╣Ар╕зр╕ер╕▓р╕Ир╕▓р╕Б NTP server
echo "ЁЯФД р╕Бр╕│р╕ер╕▒р╕Зр╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓р╕Ир╕▓р╕Б NTP server..."
systemctl restart systemd-timesyncd

# р╕гр╕нр╣Гр╕лр╣Йр╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕кр╕гр╣Зр╕И
sleep 3

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Hardware Clock
echo "тЪЩя╕П р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Hardware Clock..."
hwclock --systohc

# р╣Бр╕кр╕Фр╕Зр╣Ар╕зр╕ер╕▓р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ
echo ""
echo "ЁЯОЙ р╣Ар╕зр╕ер╕▓р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕ер╣Йр╕з:"
show_current_time

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щр╣Ар╕зр╕ер╕▓р╣Др╕Чр╕вр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
CURRENT_TZ=$(timedatectl show --property=Timezone --value)
if [ "$CURRENT_TZ" = "Asia/Bangkok" ]; then
    echo "тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕зр╕ер╕▓р╣Др╕Чр╕вр╕кр╕│р╣Ар╕гр╣Зр╕И!"
else
    echo "тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: timezone р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Гр╕Кр╣И Asia/Bangkok"
    echo "timezone р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ: $CURRENT_TZ"
fi

# ============================================
# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ MySQL timezone (р╕Цр╣Йр╕▓р╕бр╕╡ MySQL)
# ============================================

echo ""
echo "ЁЯЧДя╕П р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Бр╕ер╕░р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ MySQL timezone..."

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ MySQL р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if command -v mysql &> /dev/null; then
    echo "р╕Юр╕Ъ MySQL - р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone..."
    
    # р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М config р╕кр╕│р╕лр╕гр╕▒р╕Ъ MySQL
    cat > /etc/mysql/conf.d/timezone.cnf << EOF
[mysqld]
default-time-zone = '+07:00'
EOF

    echo "тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М config MySQL р╕кр╕│р╣Ар╕гр╣Зр╕И"
    echo "ЁЯУЭ р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Ч MySQL р╕Фр╣Йр╕зр╕вр╕Др╕│р╕кр╕▒р╣Ир╕З: sudo systemctl restart mysql"
    
elif command -v mariadb &> /dev/null; then
    echo "р╕Юр╕Ъ MariaDB - р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone..."
    
    # р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М config р╕кр╕│р╕лр╕гр╕▒р╕Ъ MariaDB
    cat > /etc/mysql/mariadb.conf.d/50-timezone.cnf << EOF
[mysqld]
default-time-zone = '+07:00'
EOF

    echo "тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М config MariaDB р╕кр╕│р╣Ар╕гр╣Зр╕И"
    echo "ЁЯУЭ р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Ч MariaDB р╕Фр╣Йр╕зр╕вр╕Др╕│р╕кр╕▒р╣Ир╕З: sudo systemctl restart mariadb"
else
    echo "тД╣я╕П р╣Др╕бр╣Ир╕Юр╕Ъ MySQL/MariaDB р╣Гр╕Щр╕гр╕░р╕Ър╕Ъ"
fi

# ============================================
# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Node.js timezone (р╕Цр╣Йр╕▓р╕бр╕╡ Node.js)
# ============================================

echo ""
echo "ЁЯЯв р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Node.js timezone..."

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ Node.js р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if command -v node &> /dev/null; then
    echo "р╕Юр╕Ъ Node.js - р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone..."
    
    # р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone р╣Гр╕Щ .bashrc
    echo "" >> ~/.bashrc
    echo "# Thailand timezone for Node.js" >> ~/.bashrc
    echo "export TZ='Asia/Bangkok'" >> ~/.bashrc
    
    # р╣Ар╕Юр╕┤р╣Ир╕бр╣Гр╕Щ .profile
    echo "" >> ~/.profile
    echo "# Thailand timezone for Node.js" >> ~/.profile
    echo "export TZ='Asia/Bangkok'" >> ~/.profile
    
    echo "тЬЕ р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone р╣Гр╕Щ .bashrc р╣Бр╕ер╕░ .profile"
    echo "ЁЯУЭ р╕Бр╕гр╕╕р╕Ур╕▓ logout/login р╣Гр╕лр╕бр╣И р╕лр╕гр╕╖р╕нр╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З: source ~/.bashrc"
else
    echo "тД╣я╕П р╣Др╕бр╣Ир╕Юр╕Ъ Node.js р╣Гр╕Щр╕гр╕░р╕Ър╕Ъ"
fi

# ============================================
# р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓
# ============================================

echo ""
echo "ЁЯУД р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓..."

# р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓
cat > /usr/local/bin/check-thai-time << 'EOF'
#!/bin/bash
echo "ЁЯЗ╣ЁЯЗн р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓р╣Др╕Чр╕в"
echo "===================="
echo "System Time: $(date)"
echo "UTC Time: $(date -u)"
echo "Timezone: $(timedatectl show --property=Timezone --value)"
echo "NTP Status: $(timedatectl show --property=NTP --value)"
echo "Time Sync: $(timedatectl show --property=NTPSynchronized --value)"
echo ""

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ MySQL timezone р╕Цр╣Йр╕▓р╕бр╕╡
if command -v mysql &> /dev/null; then
    echo "MySQL timezone:"
    mysql -e "SELECT @@system_time_zone, @@session.time_zone;" 2>/dev/null || echo "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н MySQL"
fi

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Node.js timezone р╕Цр╣Йр╕▓р╕бр╕╡
if command -v node &> /dev/null; then
    echo "Node.js timezone:"
    node -e "console.log('TZ env:', process.env.TZ); console.log('Date:', new Date().toString());"
fi
EOF

# р╣Гр╕лр╣Йр╕кр╕┤р╕Чр╕Шр╕┤р╣М execute
chmod +x /usr/local/bin/check-thai-time

echo "тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓ /usr/local/bin/check-thai-time"
echo "ЁЯУЭ р╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕З: check-thai-time р╣Ар╕Юр╕╖р╣Ир╕нр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓"

# ============================================
# р╕кр╕гр╣Йр╕▓р╕З cron job р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓
# ============================================

echo ""
echo "тП░ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ cron job р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓..."

# р╣Ар╕Юр╕┤р╣Ир╕б cron job р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓р╕Чр╕╕р╕Бр╕зр╕▒р╕Щ
(crontab -l 2>/dev/null; echo "0 2 * * * /usr/sbin/ntpdate -s time.nist.gov") | crontab -

echo "тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б cron job р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓р╕Чр╕╕р╕Бр╕зр╕▒р╕Щр╣Ар╕зр╕ер╕▓ 02:00"

# ============================================
# р╣Бр╕кр╕Фр╕Зр╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓
# ============================================

echo ""
echo "ЁЯОЙ р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓"
echo "===================="
echo "тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ timezone р╣Ар╕Ыр╣Зр╕Щ Asia/Bangkok"
echo "тЬЕ р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ NTP"
echo "тЬЕ р╕Лр╕┤р╕Зр╕Др╣М Hardware Clock"
echo "тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓"
echo "тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ cron job р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓"

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Бр╕ер╕░р╣Бр╕кр╕Фр╕Зр╣Др╕Яр╕ер╣М config р╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕З
if [ -f "/etc/mysql/conf.d/timezone.cnf" ] || [ -f "/etc/mysql/mariadb.conf.d/50-timezone.cnf" ]; then
    echo "тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ MySQL/MariaDB timezone"
fi

if grep -q "TZ='Asia/Bangkok'" ~/.bashrc; then
    echo "тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Node.js timezone"
fi

echo ""
echo "ЁЯУЛ р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣М:"
echo "- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕зр╕ер╕▓: check-thai-time"
echo "- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░: timedatectl status"
echo "- р╕Лр╕┤р╕Зр╕Др╣Мр╣Ар╕зр╕ер╕▓р╕Чр╕▒р╕Щр╕Чр╕╡: sudo systemctl restart systemd-timesyncd"
echo "- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ NTP: timedatectl timesync-status"

echo ""
echo "ЁЯФД р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Чр╣Ар╕Лр╕нр╕гр╣Мр╕зр╕┤р╕к MySQL р╣Бр╕ер╕░ logout/login р╣Гр╕лр╕бр╣И"
echo "ЁЯЗ╣ЁЯЗн р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕зр╕ер╕▓р╣Др╕Чр╕вр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ!"
